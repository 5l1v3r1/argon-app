"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var web_view_1 = require("ui/web-view");
var Argon = require("@argonjs/argon");
var observable_array_1 = require("data/observable-array");
var properties_1 = require("ui/core/properties");
exports.urlProperty = new properties_1.Property({
    name: 'url',
    defaultValue: ''
});
exports.urlProperty.set = function (v) { throw new Error('Use the src property to load another page'); };
exports.titleProperty = new properties_1.Property({
    name: 'title',
    defaultValue: ''
});
exports.titleProperty.set = undefined;
exports.progressProperty = new properties_1.Property({
    name: 'progress',
    defaultValue: 0
});
exports.progressProperty.set = undefined;
exports.sessionProperty = new properties_1.Property({
    name: 'session',
    defaultValue: undefined,
});
exports.sessionProperty.set = undefined;
exports.isArgonPageProperty = new properties_1.Property({
    name: 'isArgonPage',
    defaultValue: false,
});
exports.isArgonPageProperty.set = undefined;
var ArgonWebView = /** @class */ (function (_super) {
    __extends(ArgonWebView, _super);
    function ArgonWebView() {
        var _this = _super.call(this) || this;
        _this.log = new observable_array_1.ObservableArray();
        return _this;
    }
    ArgonWebView.prototype._didCommitNavigation = function () {
        if (this.session)
            this.session.close();
        this.log.length = 0;
        exports.sessionProperty.nativeValueChange(this, undefined);
        this._outputPort = undefined;
    };
    ArgonWebView.prototype._handleArgonMessage = function (message) {
        var _this = this;
        if (this.session && !this.session.isConnected)
            return;
        var sessionUrl = this.url;
        if (!this.session && sessionUrl) {
            console.log('Connecting to argon.js session at ' + sessionUrl);
            var manager = Argon.ArgonSystem.instance;
            var messageChannel = manager.session.createSynchronousMessageChannel();
            var session = manager.session.addManagedSessionPort(sessionUrl);
            var port = messageChannel.port2;
            port.onmessage = function (msg) {
                if (!_this.session)
                    return;
                var injectedMessage = "typeof __ARGON_PORT__ !== 'undefined' && __ARGON_PORT__.postMessage(" + msg.data + ")";
                _this.evaluateJavascriptWithoutPromise(injectedMessage);
            };
            exports.sessionProperty.nativeValueChange(this, session);
            this._outputPort = port;
            session.open(messageChannel.port1, manager.session.configuration);
        }
        // console.log(message);
        this._outputPort && this._outputPort.postMessage(JSON.parse(message));
    };
    ArgonWebView.prototype._handleWebXRMessage = function (message) {
    };
    ArgonWebView.prototype._handleLogMessage = function (message) {
        var log = JSON.parse(message);
        log.lines = log.message.split(/\r\n|\r|\n/);
        // console.log(this.url + ' (' + log.type + '): ' + log.lines.join('\n\t > ')); 
        this.log.push(log);
    };
    ArgonWebView.prototype.on = function (event, callback, thisArg) {
        return _super.prototype.on.call(this, event, callback, thisArg);
    };
    return ArgonWebView;
}(web_view_1.WebView));
exports.ArgonWebView = ArgonWebView;
exports.urlProperty.register(ArgonWebView);
exports.titleProperty.register(ArgonWebView);
exports.progressProperty.register(ArgonWebView);
exports.sessionProperty.register(ArgonWebView);
exports.isArgonPageProperty.register(ArgonWebView);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJnb24td2ViLXZpZXctY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXJnb24td2ViLXZpZXctY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esd0NBQW1DO0FBQ25DLHNDQUF1QztBQUN2QywwREFBc0Q7QUFDdEQsaURBQTJDO0FBRTlCLFFBQUEsV0FBVyxHQUFHLElBQUkscUJBQVEsQ0FBdUI7SUFDMUQsSUFBSSxFQUFFLEtBQUs7SUFDWCxZQUFZLEVBQUUsRUFBRTtDQUNuQixDQUFDLENBQUE7QUFDRixtQkFBVyxDQUFDLEdBQUcsR0FBRyxVQUFDLENBQUMsSUFBTyxNQUFNLElBQUksS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFOUUsUUFBQSxhQUFhLEdBQUcsSUFBSSxxQkFBUSxDQUF1QjtJQUM1RCxJQUFJLEVBQUUsT0FBTztJQUNiLFlBQVksRUFBRSxFQUFFO0NBQ25CLENBQUMsQ0FBQTtBQUNGLHFCQUFhLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztBQUVqQixRQUFBLGdCQUFnQixHQUFHLElBQUkscUJBQVEsQ0FBdUI7SUFDL0QsSUFBSSxFQUFFLFVBQVU7SUFDaEIsWUFBWSxFQUFFLENBQUM7Q0FDbEIsQ0FBQyxDQUFBO0FBQ0Ysd0JBQWdCLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztBQUVwQixRQUFBLGVBQWUsR0FBRyxJQUFJLHFCQUFRLENBQWtDO0lBQ3pFLElBQUksRUFBRSxTQUFTO0lBQ2YsWUFBWSxFQUFFLFNBQVM7Q0FDMUIsQ0FBQyxDQUFBO0FBQ0YsdUJBQWUsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDO0FBRW5CLFFBQUEsbUJBQW1CLEdBQUcsSUFBSSxxQkFBUSxDQUF3QjtJQUNuRSxJQUFJLEVBQUUsYUFBYTtJQUNuQixZQUFZLEVBQUUsS0FBSztDQUN0QixDQUFDLENBQUE7QUFDRiwyQkFBbUIsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDO0FB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a0JBQU8sR0F1RWpEO0FBdkVxQixvQ0FBWTtBQXlFbEMsbUJBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDbkMscUJBQWEsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDckMsd0JBQWdCLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hDLHVCQUFlLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLDJCQUFtQixDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRlZiBmcm9tICcuJ1xuaW1wb3J0IHtXZWJWaWV3fSBmcm9tICd1aS93ZWItdmlldydcbmltcG9ydCAqIGFzIEFyZ29uIGZyb20gJ0BhcmdvbmpzL2FyZ29uJ1xuaW1wb3J0IHtPYnNlcnZhYmxlQXJyYXl9IGZyb20gJ2RhdGEvb2JzZXJ2YWJsZS1hcnJheSc7ICAgIFxuaW1wb3J0IHtQcm9wZXJ0eX0gZnJvbSAndWkvY29yZS9wcm9wZXJ0aWVzJ1xuXG5leHBvcnQgY29uc3QgdXJsUHJvcGVydHkgPSBuZXcgUHJvcGVydHk8QXJnb25XZWJWaWV3LCBzdHJpbmc+KHtcbiAgICBuYW1lOiAndXJsJyxcbiAgICBkZWZhdWx0VmFsdWU6ICcnXG59KVxudXJsUHJvcGVydHkuc2V0ID0gKHYpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdVc2UgdGhlIHNyYyBwcm9wZXJ0eSB0byBsb2FkIGFub3RoZXIgcGFnZScpOyB9O1xuXG5leHBvcnQgY29uc3QgdGl0bGVQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxBcmdvbldlYlZpZXcsIHN0cmluZz4oe1xuICAgIG5hbWU6ICd0aXRsZScsXG4gICAgZGVmYXVsdFZhbHVlOiAnJ1xufSlcbnRpdGxlUHJvcGVydHkuc2V0ID0gdW5kZWZpbmVkO1xuXG5leHBvcnQgY29uc3QgcHJvZ3Jlc3NQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxBcmdvbldlYlZpZXcsIG51bWJlcj4oe1xuICAgIG5hbWU6ICdwcm9ncmVzcycsXG4gICAgZGVmYXVsdFZhbHVlOiAwXG59KVxucHJvZ3Jlc3NQcm9wZXJ0eS5zZXQgPSB1bmRlZmluZWQ7XG5cbmV4cG9ydCBjb25zdCBzZXNzaW9uUHJvcGVydHkgPSBuZXcgUHJvcGVydHk8QXJnb25XZWJWaWV3LCBBcmdvbi5TZXNzaW9uUG9ydD4oe1xuICAgIG5hbWU6ICdzZXNzaW9uJyxcbiAgICBkZWZhdWx0VmFsdWU6IHVuZGVmaW5lZCxcbn0pXG5zZXNzaW9uUHJvcGVydHkuc2V0ID0gdW5kZWZpbmVkO1xuXG5leHBvcnQgY29uc3QgaXNBcmdvblBhZ2VQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxBcmdvbldlYlZpZXcsIGJvb2xlYW4+KHtcbiAgICBuYW1lOiAnaXNBcmdvblBhZ2UnLFxuICAgIGRlZmF1bHRWYWx1ZTogZmFsc2UsXG59KVxuaXNBcmdvblBhZ2VQcm9wZXJ0eS5zZXQgPSB1bmRlZmluZWQ7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBcmdvbldlYlZpZXcgZXh0ZW5kcyBXZWJWaWV3IGltcGxlbWVudHMgZGVmLkFyZ29uV2ViVmlldyB7XG4gICAgXG4gICAgcHVibGljIHJlYWRvbmx5IHVybCA6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgdGl0bGUgOiBzdHJpbmc7XG4gICAgcHVibGljIHJlYWRvbmx5IHByb2dyZXNzIDogbnVtYmVyOyAvLyByYW5nZSBpcyAwIHRvIDEuMFxuICAgIHB1YmxpYyByZWFkb25seSBpc0FyZ29uUGFnZTpib29sZWFuO1xuICAgIHB1YmxpYyByZWFkb25seSBsb2cgPSBuZXcgT2JzZXJ2YWJsZUFycmF5PGRlZi5Mb2dJdGVtPigpO1xuICAgIHB1YmxpYyByZWFkb25seSBzZXNzaW9uPzpBcmdvbi5TZXNzaW9uUG9ydDtcblxuICAgIHByaXZhdGUgX291dHB1dFBvcnQ/OkFyZ29uLk1lc3NhZ2VQb3J0TGlrZTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfZGlkQ29tbWl0TmF2aWdhdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuc2Vzc2lvbikgdGhpcy5zZXNzaW9uLmNsb3NlKCk7XG4gICAgICAgIHRoaXMubG9nLmxlbmd0aCA9IDA7XG4gICAgICAgIFxuICAgICAgICBzZXNzaW9uUHJvcGVydHkubmF0aXZlVmFsdWVDaGFuZ2UodGhpcywgdW5kZWZpbmVkKTtcbiAgICAgICAgdGhpcy5fb3V0cHV0UG9ydCA9IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgX2hhbmRsZUFyZ29uTWVzc2FnZShtZXNzYWdlOnN0cmluZykge1xuXG4gICAgICAgIGlmICh0aGlzLnNlc3Npb24gJiYgIXRoaXMuc2Vzc2lvbi5pc0Nvbm5lY3RlZCkgcmV0dXJuO1xuICAgICAgICBjb25zdCBzZXNzaW9uVXJsID0gdGhpcy51cmw7XG5cbiAgICAgICAgaWYgKCF0aGlzLnNlc3Npb24gJiYgc2Vzc2lvblVybCkgeyBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0Nvbm5lY3RpbmcgdG8gYXJnb24uanMgc2Vzc2lvbiBhdCAnICsgc2Vzc2lvblVybCk7XG4gICAgICAgICAgICBjb25zdCBtYW5hZ2VyID0gQXJnb24uQXJnb25TeXN0ZW0uaW5zdGFuY2UhO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZUNoYW5uZWwgPSBtYW5hZ2VyLnNlc3Npb24uY3JlYXRlU3luY2hyb25vdXNNZXNzYWdlQ2hhbm5lbCgpO1xuICAgICAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IG1hbmFnZXIuc2Vzc2lvbi5hZGRNYW5hZ2VkU2Vzc2lvblBvcnQoc2Vzc2lvblVybCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHBvcnQgPSBtZXNzYWdlQ2hhbm5lbC5wb3J0MjtcbiAgICAgICAgICAgIHBvcnQub25tZXNzYWdlID0gKG1zZzpBcmdvbi5NZXNzYWdlRXZlbnRMaWtlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNlc3Npb24pIHJldHVybjtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmplY3RlZE1lc3NhZ2UgPSBcInR5cGVvZiBfX0FSR09OX1BPUlRfXyAhPT0gJ3VuZGVmaW5lZCcgJiYgX19BUkdPTl9QT1JUX18ucG9zdE1lc3NhZ2UoXCIrbXNnLmRhdGErXCIpXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0ZUphdmFzY3JpcHRXaXRob3V0UHJvbWlzZShpbmplY3RlZE1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uUHJvcGVydHkubmF0aXZlVmFsdWVDaGFuZ2UodGhpcywgc2Vzc2lvbik7XG4gICAgICAgICAgICB0aGlzLl9vdXRwdXRQb3J0ID0gcG9ydDtcblxuICAgICAgICAgICAgc2Vzc2lvbi5vcGVuKG1lc3NhZ2VDaGFubmVsLnBvcnQxLCBtYW5hZ2VyLnNlc3Npb24uY29uZmlndXJhdGlvbilcbiAgICAgICAgfVxuICAgICAgICAvLyBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICAgICAgdGhpcy5fb3V0cHV0UG9ydCAmJiB0aGlzLl9vdXRwdXRQb3J0LnBvc3RNZXNzYWdlKEpTT04ucGFyc2UobWVzc2FnZSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfaGFuZGxlV2ViWFJNZXNzYWdlKG1lc3NhZ2U6c3RyaW5nKSB7XG4gICAgICAgIFxuICAgIH1cblxuICAgIHB1YmxpYyBfaGFuZGxlTG9nTWVzc2FnZShtZXNzYWdlOnN0cmluZykge1xuICAgICAgICBjb25zdCBsb2c6ZGVmLkxvZ0l0ZW0gPSBKU09OLnBhcnNlKG1lc3NhZ2UpO1xuICAgICAgICBsb2cubGluZXMgPSBsb2cubWVzc2FnZS5zcGxpdCgvXFxyXFxufFxccnxcXG4vKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2codGhpcy51cmwgKyAnICgnICsgbG9nLnR5cGUgKyAnKTogJyArIGxvZy5saW5lcy5qb2luKCdcXG5cXHQgPiAnKSk7IFxuICAgICAgICB0aGlzLmxvZy5wdXNoKGxvZyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFic3RyYWN0IGV2YWx1YXRlSmF2YXNjcmlwdChzY3JpcHQ6c3RyaW5nKSA6IFByb21pc2U8YW55PjtcbiAgICBwdWJsaWMgYWJzdHJhY3QgZXZhbHVhdGVKYXZhc2NyaXB0V2l0aG91dFByb21pc2Uoc2NyaXB0OnN0cmluZykgOiB2b2lkO1xuXG4gICAgcHVibGljIGFic3RyYWN0IGJyaW5nVG9Gcm9udCgpO1xuICAgIFxuICAgIHB1YmxpYyBvbihldmVudDogc3RyaW5nLCBjYWxsYmFjazogKGRhdGE6IGFueSkgPT4gdm9pZCwgdGhpc0FyZz86IGFueSkge1xuICAgICAgICByZXR1cm4gc3VwZXIub24oZXZlbnQsIGNhbGxiYWNrLCB0aGlzQXJnKTtcbiAgICB9XG5cbn1cblxudXJsUHJvcGVydHkucmVnaXN0ZXIoQXJnb25XZWJWaWV3KTtcbnRpdGxlUHJvcGVydHkucmVnaXN0ZXIoQXJnb25XZWJWaWV3KTtcbnByb2dyZXNzUHJvcGVydHkucmVnaXN0ZXIoQXJnb25XZWJWaWV3KTtcbnNlc3Npb25Qcm9wZXJ0eS5yZWdpc3RlcihBcmdvbldlYlZpZXcpO1xuaXNBcmdvblBhZ2VQcm9wZXJ0eS5yZWdpc3RlcihBcmdvbldlYlZpZXcpOyJdfQ==