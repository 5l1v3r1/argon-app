"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var web_view_1 = require("ui/web-view");
var Argon = require("@argonjs/argon");
var observable_array_1 = require("data/observable-array");
var properties_1 = require("ui/core/properties");
exports.urlProperty = new properties_1.Property({
    name: 'url',
    defaultValue: ''
});
exports.urlProperty.set = function (v) { throw new Error('Use the src property to load another page'); };
exports.titleProperty = new properties_1.Property({
    name: 'title',
    defaultValue: ''
});
exports.titleProperty.set = undefined;
exports.progressProperty = new properties_1.Property({
    name: 'progress',
    defaultValue: 0
});
exports.progressProperty.set = undefined;
exports.sessionProperty = new properties_1.Property({
    name: 'session',
    defaultValue: undefined,
});
exports.sessionProperty.set = undefined;
exports.isArgonPageProperty = new properties_1.Property({
    name: 'isArgonPage',
    defaultValue: false,
});
exports.isArgonPageProperty.set = undefined;
var ArgonWebView = (function (_super) {
    __extends(ArgonWebView, _super);
    function ArgonWebView() {
        var _this = _super.call(this) || this;
        _this.log = new observable_array_1.ObservableArray();
        return _this;
    }
    ArgonWebView.prototype._didCommitNavigation = function () {
        if (this.session)
            this.session.close();
        this.log.length = 0;
        exports.sessionProperty.nativeValueChange(this, undefined);
        this._outputPort = undefined;
    };
    ArgonWebView.prototype._handleArgonMessage = function (message) {
        var _this = this;
        if (this.session && !this.session.isConnected)
            return;
        var sessionUrl = this.url;
        if (!this.session && sessionUrl) {
            console.log('Connecting to argon.js session at ' + sessionUrl);
            var manager = Argon.ArgonSystem.instance;
            var messageChannel = manager.session.createSynchronousMessageChannel();
            var session = manager.session.addManagedSessionPort(sessionUrl);
            var port = messageChannel.port2;
            port.onmessage = function (msg) {
                if (!_this.session)
                    return;
                var injectedMessage = "typeof __ARGON_PORT__ !== 'undefined' && __ARGON_PORT__.postMessage(" + msg.data + ")";
                _this.evaluateJavascriptWithoutPromise(injectedMessage);
            };
            exports.sessionProperty.nativeValueChange(this, session);
            this._outputPort = port;
            session.open(messageChannel.port1, manager.session.configuration);
        }
        // console.log(message);
        this._outputPort && this._outputPort.postMessage(JSON.parse(message));
    };
    ArgonWebView.prototype._handleLogMessage = function (message) {
        var log = JSON.parse(message);
        log.lines = log.message.split(/\r\n|\r|\n/);
        // console.log(this.url + ' (' + log.type + '): ' + log.lines.join('\n\t > ')); 
        this.log.push(log);
    };
    ArgonWebView.prototype.on = function (event, callback, thisArg) {
        return _super.prototype.on.call(this, event, callback, thisArg);
    };
    return ArgonWebView;
}(web_view_1.WebView));
exports.ArgonWebView = ArgonWebView;
exports.urlProperty.register(ArgonWebView);
exports.titleProperty.register(ArgonWebView);
exports.progressProperty.register(ArgonWebView);
exports.sessionProperty.register(ArgonWebView);
exports.isArgonPageProperty.register(ArgonWebView);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJnb24td2ViLXZpZXctY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXJnb24td2ViLXZpZXctY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esd0NBQW1DO0FBQ25DLHNDQUF1QztBQUN2QywwREFBc0Q7QUFDdEQsaURBQTJDO0FBRTlCLFFBQUEsV0FBVyxHQUFHLElBQUkscUJBQVEsQ0FBdUI7SUFDMUQsSUFBSSxFQUFFLEtBQUs7SUFDWCxZQUFZLEVBQUUsRUFBRTtDQUNuQixDQUFDLENBQUE7QUFDRixtQkFBVyxDQUFDLEdBQUcsR0FBRyxVQUFDLENBQUMsSUFBTyxNQUFNLElBQUksS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFOUUsUUFBQSxhQUFhLEdBQUcsSUFBSSxxQkFBUSxDQUF1QjtJQUM1RCxJQUFJLEVBQUUsT0FBTztJQUNiLFlBQVksRUFBRSxFQUFFO0NBQ25CLENBQUMsQ0FBQTtBQUNGLHFCQUFhLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztBQUVqQixRQUFBLGdCQUFnQixHQUFHLElBQUkscUJBQVEsQ0FBdUI7SUFDL0QsSUFBSSxFQUFFLFVBQVU7SUFDaEIsWUFBWSxFQUFFLENBQUM7Q0FDbEIsQ0FBQyxDQUFBO0FBQ0Ysd0JBQWdCLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztBQUVwQixRQUFBLGVBQWUsR0FBRyxJQUFJLHFCQUFRLENBQWtDO0lBQ3pFLElBQUksRUFBRSxTQUFTO0lBQ2YsWUFBWSxFQUFFLFNBQVM7Q0FDMUIsQ0FBQyxDQUFBO0FBQ0YsdUJBQWUsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDO0FBRW5CLFFBQUEsbUJBQW1CLEdBQUcsSUFBSSxxQkFBUSxDQUF3QjtJQUNuRSxJQUFJLEVBQUUsYUFBYTtJQUNuQixZQUFZLEVBQUUsS0FBSztDQUN0QixDQUFDLENBQUE7QUFDRiwyQkFBbUIsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDO0FB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QUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNuQyxxQkFBYSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNyQyx3QkFBZ0IsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDeEMsdUJBQWUsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdkMsMkJBQW1CLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZGVmIGZyb20gJy4nXG5pbXBvcnQge1dlYlZpZXd9IGZyb20gJ3VpL3dlYi12aWV3J1xuaW1wb3J0ICogYXMgQXJnb24gZnJvbSAnQGFyZ29uanMvYXJnb24nXG5pbXBvcnQge09ic2VydmFibGVBcnJheX0gZnJvbSAnZGF0YS9vYnNlcnZhYmxlLWFycmF5JzsgICAgXG5pbXBvcnQge1Byb3BlcnR5fSBmcm9tICd1aS9jb3JlL3Byb3BlcnRpZXMnXG5cbmV4cG9ydCBjb25zdCB1cmxQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxBcmdvbldlYlZpZXcsIHN0cmluZz4oe1xuICAgIG5hbWU6ICd1cmwnLFxuICAgIGRlZmF1bHRWYWx1ZTogJydcbn0pXG51cmxQcm9wZXJ0eS5zZXQgPSAodikgPT4geyB0aHJvdyBuZXcgRXJyb3IoJ1VzZSB0aGUgc3JjIHByb3BlcnR5IHRvIGxvYWQgYW5vdGhlciBwYWdlJyk7IH07XG5cbmV4cG9ydCBjb25zdCB0aXRsZVByb3BlcnR5ID0gbmV3IFByb3BlcnR5PEFyZ29uV2ViVmlldywgc3RyaW5nPih7XG4gICAgbmFtZTogJ3RpdGxlJyxcbiAgICBkZWZhdWx0VmFsdWU6ICcnXG59KVxudGl0bGVQcm9wZXJ0eS5zZXQgPSB1bmRlZmluZWQ7XG5cbmV4cG9ydCBjb25zdCBwcm9ncmVzc1Byb3BlcnR5ID0gbmV3IFByb3BlcnR5PEFyZ29uV2ViVmlldywgbnVtYmVyPih7XG4gICAgbmFtZTogJ3Byb2dyZXNzJyxcbiAgICBkZWZhdWx0VmFsdWU6IDBcbn0pXG5wcm9ncmVzc1Byb3BlcnR5LnNldCA9IHVuZGVmaW5lZDtcblxuZXhwb3J0IGNvbnN0IHNlc3Npb25Qcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxBcmdvbldlYlZpZXcsIEFyZ29uLlNlc3Npb25Qb3J0Pih7XG4gICAgbmFtZTogJ3Nlc3Npb24nLFxuICAgIGRlZmF1bHRWYWx1ZTogdW5kZWZpbmVkLFxufSlcbnNlc3Npb25Qcm9wZXJ0eS5zZXQgPSB1bmRlZmluZWQ7XG5cbmV4cG9ydCBjb25zdCBpc0FyZ29uUGFnZVByb3BlcnR5ID0gbmV3IFByb3BlcnR5PEFyZ29uV2ViVmlldywgYm9vbGVhbj4oe1xuICAgIG5hbWU6ICdpc0FyZ29uUGFnZScsXG4gICAgZGVmYXVsdFZhbHVlOiBmYWxzZSxcbn0pXG5pc0FyZ29uUGFnZVByb3BlcnR5LnNldCA9IHVuZGVmaW5lZDtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFyZ29uV2ViVmlldyBleHRlbmRzIFdlYlZpZXcgaW1wbGVtZW50cyBkZWYuQXJnb25XZWJWaWV3IHtcbiAgICBcbiAgICBwdWJsaWMgcmVhZG9ubHkgdXJsIDogc3RyaW5nO1xuICAgIHB1YmxpYyByZWFkb25seSB0aXRsZSA6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgcHJvZ3Jlc3MgOiBudW1iZXI7IC8vIHJhbmdlIGlzIDAgdG8gMS4wXG4gICAgcHVibGljIHJlYWRvbmx5IGlzQXJnb25QYWdlOmJvb2xlYW47XG4gICAgcHVibGljIHJlYWRvbmx5IGxvZyA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8ZGVmLkxvZ0l0ZW0+KCk7XG4gICAgcHVibGljIHJlYWRvbmx5IHNlc3Npb24/OkFyZ29uLlNlc3Npb25Qb3J0O1xuXG4gICAgcHJpdmF0ZSBfb3V0cHV0UG9ydD86QXJnb24uTWVzc2FnZVBvcnRMaWtlO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIF9kaWRDb21taXROYXZpZ2F0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5zZXNzaW9uKSB0aGlzLnNlc3Npb24uY2xvc2UoKTtcbiAgICAgICAgdGhpcy5sb2cubGVuZ3RoID0gMDtcbiAgICAgICAgXG4gICAgICAgIHNlc3Npb25Qcm9wZXJ0eS5uYXRpdmVWYWx1ZUNoYW5nZSh0aGlzLCB1bmRlZmluZWQpO1xuICAgICAgICB0aGlzLl9vdXRwdXRQb3J0ID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBfaGFuZGxlQXJnb25NZXNzYWdlKG1lc3NhZ2U6c3RyaW5nKSB7XG5cbiAgICAgICAgaWYgKHRoaXMuc2Vzc2lvbiAmJiAhdGhpcy5zZXNzaW9uLmlzQ29ubmVjdGVkKSByZXR1cm47XG4gICAgICAgIGNvbnN0IHNlc3Npb25VcmwgPSB0aGlzLnVybDtcblxuICAgICAgICBpZiAoIXRoaXMuc2Vzc2lvbiAmJiBzZXNzaW9uVXJsKSB7IFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ29ubmVjdGluZyB0byBhcmdvbi5qcyBzZXNzaW9uIGF0ICcgKyBzZXNzaW9uVXJsKTtcbiAgICAgICAgICAgIGNvbnN0IG1hbmFnZXIgPSBBcmdvbi5BcmdvblN5c3RlbS5pbnN0YW5jZSE7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlQ2hhbm5lbCA9IG1hbmFnZXIuc2Vzc2lvbi5jcmVhdGVTeW5jaHJvbm91c01lc3NhZ2VDaGFubmVsKCk7XG4gICAgICAgICAgICBjb25zdCBzZXNzaW9uID0gbWFuYWdlci5zZXNzaW9uLmFkZE1hbmFnZWRTZXNzaW9uUG9ydChzZXNzaW9uVXJsKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcG9ydCA9IG1lc3NhZ2VDaGFubmVsLnBvcnQyO1xuICAgICAgICAgICAgcG9ydC5vbm1lc3NhZ2UgPSAobXNnOkFyZ29uLk1lc3NhZ2VFdmVudExpa2UpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc2Vzc2lvbikgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGNvbnN0IGluamVjdGVkTWVzc2FnZSA9IFwidHlwZW9mIF9fQVJHT05fUE9SVF9fICE9PSAndW5kZWZpbmVkJyAmJiBfX0FSR09OX1BPUlRfXy5wb3N0TWVzc2FnZShcIittc2cuZGF0YStcIilcIjtcbiAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRlSmF2YXNjcmlwdFdpdGhvdXRQcm9taXNlKGluamVjdGVkTWVzc2FnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNlc3Npb25Qcm9wZXJ0eS5uYXRpdmVWYWx1ZUNoYW5nZSh0aGlzLCBzZXNzaW9uKTtcbiAgICAgICAgICAgIHRoaXMuX291dHB1dFBvcnQgPSBwb3J0O1xuXG4gICAgICAgICAgICBzZXNzaW9uLm9wZW4obWVzc2FnZUNoYW5uZWwucG9ydDEsIG1hbmFnZXIuc2Vzc2lvbi5jb25maWd1cmF0aW9uKVxuICAgICAgICB9XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKG1lc3NhZ2UpO1xuICAgICAgICB0aGlzLl9vdXRwdXRQb3J0ICYmIHRoaXMuX291dHB1dFBvcnQucG9zdE1lc3NhZ2UoSlNPTi5wYXJzZShtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgcHVibGljIF9oYW5kbGVMb2dNZXNzYWdlKG1lc3NhZ2U6c3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGxvZzpkZWYuTG9nSXRlbSA9IEpTT04ucGFyc2UobWVzc2FnZSk7XG4gICAgICAgIGxvZy5saW5lcyA9IGxvZy5tZXNzYWdlLnNwbGl0KC9cXHJcXG58XFxyfFxcbi8pO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLnVybCArICcgKCcgKyBsb2cudHlwZSArICcpOiAnICsgbG9nLmxpbmVzLmpvaW4oJ1xcblxcdCA+ICcpKTsgXG4gICAgICAgIHRoaXMubG9nLnB1c2gobG9nKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWJzdHJhY3QgZXZhbHVhdGVKYXZhc2NyaXB0KHNjcmlwdDpzdHJpbmcpIDogUHJvbWlzZTxhbnk+O1xuICAgIHB1YmxpYyBhYnN0cmFjdCBldmFsdWF0ZUphdmFzY3JpcHRXaXRob3V0UHJvbWlzZShzY3JpcHQ6c3RyaW5nKSA6IHZvaWQ7XG5cbiAgICBwdWJsaWMgYWJzdHJhY3QgYnJpbmdUb0Zyb250KCk7XG4gICAgXG4gICAgcHVibGljIG9uKGV2ZW50OiBzdHJpbmcsIGNhbGxiYWNrOiAoZGF0YTogYW55KSA9PiB2b2lkLCB0aGlzQXJnPzogYW55KSB7XG4gICAgICAgIHJldHVybiBzdXBlci5vbihldmVudCwgY2FsbGJhY2ssIHRoaXNBcmcpO1xuICAgIH1cblxufVxuXG51cmxQcm9wZXJ0eS5yZWdpc3RlcihBcmdvbldlYlZpZXcpO1xudGl0bGVQcm9wZXJ0eS5yZWdpc3RlcihBcmdvbldlYlZpZXcpO1xucHJvZ3Jlc3NQcm9wZXJ0eS5yZWdpc3RlcihBcmdvbldlYlZpZXcpO1xuc2Vzc2lvblByb3BlcnR5LnJlZ2lzdGVyKEFyZ29uV2ViVmlldyk7XG5pc0FyZ29uUGFnZVByb3BlcnR5LnJlZ2lzdGVyKEFyZ29uV2ViVmlldyk7Il19